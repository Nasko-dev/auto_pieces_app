# DIAGRAMME ARCHITECTURE MESSAGERIE TEMPS RÃ‰EL

## ğŸ—ï¸ VUE D'ENSEMBLE - CLEAN ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PRESENTATION LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   PARTICULIER UI     â”‚    â”‚     VENDEUR UI       â”‚    â”‚   SHARED UI     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ConversationsListPageâ”‚    â”‚ MessagesPage         â”‚    â”‚ConversationItem â”‚ â”‚
â”‚  â”‚ ConversationDetail   â”‚    â”‚ ConversationDetail   â”‚    â”‚Widget           â”‚ â”‚
â”‚  â”‚ ChatPage            â”‚    â”‚                      â”‚    â”‚(Polyvalent)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â”‚                      â”‚                        â”‚          â”‚
â”‚                   â–¼                      â–¼                        â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PARTICULIER         â”‚    â”‚    VENDEUR           â”‚    â”‚   REAL-TIME     â”‚ â”‚
â”‚  â”‚  CONTROLLERS         â”‚    â”‚    CONTROLLERS       â”‚    â”‚   SERVICE       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ParticulierConvers.   â”‚    â”‚ ConversationsCtrl    â”‚    â”‚ RealtimeService â”‚ â”‚
â”‚  â”‚Controller            â”‚    â”‚                      â”‚    â”‚ (CentralisÃ©)    â”‚ â”‚
â”‚  â”‚+ loadConversations() â”‚    â”‚+ getConversations()  â”‚    â”‚+ subscriptions  â”‚ â”‚
â”‚  â”‚+ calcUnreadCounts()  â”‚    â”‚+ sendMessage()       â”‚    â”‚+ globalMessages â”‚ â”‚
â”‚  â”‚+ realtime subscript. â”‚    â”‚+ markAsRead()        â”‚    â”‚+ polling 30s    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                   â”‚                      â”‚                        â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                      â”‚                        â”‚
                    â–¼                      â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               DOMAIN LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    PARTICULIER       â”‚    â”‚      VENDEUR         â”‚    â”‚     SHARED      â”‚ â”‚
â”‚  â”‚     ENTITIES         â”‚    â”‚      ENTITIES        â”‚    â”‚    ENTITIES     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ParticulierConversationâ”‚   â”‚ Conversation         â”‚    â”‚ConversationEnum â”‚ â”‚
â”‚  â”‚+ id: String          â”‚    â”‚+ id: String          â”‚    â”‚MessageType      â”‚ â”‚
â”‚  â”‚+ partRequest         â”‚    â”‚+ requestId           â”‚    â”‚MessageSenderTypeâ”‚ â”‚
â”‚  â”‚+ sellerName          â”‚    â”‚+ userId/sellerId     â”‚    â”‚ConversationStat.â”‚ â”‚
â”‚  â”‚+ messages: List<>    â”‚    â”‚+ lastMessageContent  â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚+ unreadCount: int â­  â”‚    â”‚+ unreadCount: int â­  â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚+ hasUnreadMessages   â”‚    â”‚+ totalMessages       â”‚    â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ ParticulierMessage   â”‚    â”‚     Message          â”‚                      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
â”‚  â”‚+ id: String          â”‚    â”‚+ id: String          â”‚                      â”‚
â”‚  â”‚+ conversationId      â”‚    â”‚+ conversationId      â”‚                      â”‚
â”‚  â”‚+ senderId            â”‚    â”‚+ senderId            â”‚                      â”‚
â”‚  â”‚+ content: String     â”‚    â”‚+ senderType â­        â”‚                      â”‚
â”‚  â”‚+ isFromParticulierâ­  â”‚    â”‚+ content: String     â”‚                      â”‚
â”‚  â”‚+ isRead: bool â­      â”‚    â”‚+ isRead: bool â­      â”‚                      â”‚
â”‚  â”‚+ createdAt           â”‚    â”‚+ createdAt           â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    REPOSITORY INTERFACES                               â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ PartRequestRepository                                                   â”‚ â”‚
â”‚  â”‚ + getParticulierConversations(): Either<Failure, List<ParticConvers>>  â”‚ â”‚
â”‚  â”‚ + getParticulierConversationById(): Either<Failure, ParticConvers>     â”‚ â”‚
â”‚  â”‚ + sendParticulierMessage(): Either<Failure, void>                      â”‚ â”‚
â”‚  â”‚ + markParticulierConversationAsRead(): Either<Failure, void>           â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ ConversationsRepository                                                 â”‚ â”‚
â”‚  â”‚ + getConversations(): Either<Failure, List<Conversation>>              â”‚ â”‚
â”‚  â”‚ + sendMessage(): Either<Failure, Message>                              â”‚ â”‚
â”‚  â”‚ + markMessagesAsRead(): Either<Failure, void>                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 DATA LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       REPOSITORY IMPLEMENTATIONS                        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ PartRequestRepositoryImpl                                               â”‚ â”‚
â”‚  â”‚ + getParticulierConversations() {                                      â”‚ â”‚
â”‚  â”‚     return remoteDataSource.getParticulierConversations()              â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚                                      â”‚
â”‚                                      â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                          REMOTE DATA SOURCES                           â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ConversationsRemoteDataSourceImpl                                      â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ + getConversations(userId) {                                           â”‚ â”‚
â”‚  â”‚     // ğŸ” AUTO-DÃ‰TECTION TYPE UTILISATEUR                             â”‚ â”‚
â”‚  â”‚     if (_checkIfUserIsSeller(userId)) {                               â”‚ â”‚
â”‚  â”‚       return _getSellerConversations(userId)                          â”‚ â”‚
â”‚  â”‚     } else {                                                           â”‚ â”‚
â”‚  â”‚       return _getParticulierConversations(userId)                     â”‚ â”‚
â”‚  â”‚     }                                                                   â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ + _getParticulierConversations() {                                     â”‚ â”‚
â”‚  â”‚     // ğŸ“± DEVICE ID LOOKUP pour persistance                           â”‚ â”‚
â”‚  â”‚     deviceId = await deviceService.getDeviceId()                      â”‚ â”‚
â”‚  â”‚     particuliers = supabase.from('particuliers')                      â”‚ â”‚
â”‚  â”‚                          .select('id')                                â”‚ â”‚
â”‚  â”‚                          .eq('device_id', deviceId)                   â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ + _getSellerConversations() {                                          â”‚ â”‚
â”‚  â”‚     // ğŸ§® CALCUL LOCAL UNREAD COUNT                                    â”‚ â”‚
â”‚  â”‚     messages = await getMessages(conversationId)                       â”‚ â”‚
â”‚  â”‚     unreadCount = messages.where(msg =>                                â”‚ â”‚
â”‚  â”‚       !msg.isRead && msg.senderId != sellerId).length                 â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ + subscribeToNewMessages(conversationId) {                             â”‚ â”‚
â”‚  â”‚     return supabase.from('messages')                                   â”‚ â”‚
â”‚  â”‚                   .stream(primaryKey: ['id'])                          â”‚ â”‚
â”‚  â”‚                   .eq('conversation_id', conversationId)               â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ + _mapSupabaseToConversation() {                                       â”‚ â”‚
â”‚  â”‚     // ğŸ”„ MAPPING ROBUSTE sender_type                                  â”‚ â”‚
â”‚  â”‚     'senderType': json['sender_type'] ?? 'user',                       â”‚ â”‚
â”‚  â”‚     'unreadCount': json['unread_count'] ?? 0,                          â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              EXTERNAL LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     SUPABASE         â”‚    â”‚    DEVICE STORAGE    â”‚    â”‚   REAL-TIME     â”‚ â”‚
â”‚  â”‚     DATABASE         â”‚    â”‚                      â”‚    â”‚   SUBSCRIPTIONS â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€conversationsâ”€â”€â”€â” â”‚    â”‚ SharedPreferences    â”‚    â”‚ Supabase        â”‚ â”‚
â”‚  â”‚ â”‚id               â”‚ â”‚    â”‚ + device_id          â”‚    â”‚ Realtime        â”‚ â”‚
â”‚  â”‚ â”‚request_id       â”‚ â”‚    â”‚ + user_preferences   â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚user_id          â”‚ â”‚    â”‚                      â”‚    â”‚ PostgresChanges â”‚ â”‚
â”‚  â”‚ â”‚seller_id        â”‚ â”‚    â”‚ DeviceService        â”‚    â”‚ + INSERT events â”‚ â”‚
â”‚  â”‚ â”‚unread_count â­   â”‚ â”‚    â”‚ + getDeviceId()      â”‚    â”‚ + UPDATE events â”‚ â”‚
â”‚  â”‚ â”‚last_message_at  â”‚ â”‚    â”‚ + persistance cross- â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚status           â”‚ â”‚    â”‚   session            â”‚    â”‚ Channel:        â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                      â”‚    â”‚'global_messages'â”‚ â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€messagesâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚id               â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚conversation_id  â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚sender_id        â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚sender_type â­    â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚content          â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚is_read â­        â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚created_at (UTC) â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€particuliersâ”€â”€â”€â”€â” â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚id               â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚device_id â­      â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚phone            â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚                      â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€sellersâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚id               â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚company_name     â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â”‚email            â”‚ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                      â”‚    â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ FLUX DE DONNÃ‰ES - NOUVEAU MESSAGE â†’ EFFETS VISUELS

```
    ğŸ“¨ NOUVEAU MESSAGE ENVOYÃ‰
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        SUPABASE DB              â”‚
â”‚                                 â”‚
â”‚ INSERT INTO messages (          â”‚
â”‚   conversation_id: 'conv-123',  â”‚
â”‚   sender_id: 'seller-456',      â”‚
â”‚   sender_type: 'seller', â­      â”‚
â”‚   content: 'Bonjour!',          â”‚
â”‚   is_read: false â­              â”‚
â”‚ )                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ PostgreSQL NOTIFY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     SUPABASE REALTIME           â”‚
â”‚                                 â”‚
â”‚ Channel: 'global_messages'      â”‚
â”‚ Event: PostgresChangeEvent      â”‚
â”‚ Payload: {                      â”‚
â”‚   "conversation_id": "conv-123", â”‚
â”‚   "sender_id": "seller-456",    â”‚
â”‚   "sender_type": "seller"       â”‚
â”‚ }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Stream Event
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PARTICULIER CONTROLLER         â”‚
â”‚                                 â”‚
â”‚ _subscribeToGlobalMessages() {  â”‚
â”‚   channel.onPostgresChanges(    â”‚
â”‚     callback: (payload) => {    â”‚
â”‚       _handleGlobalNewMessage() â”‚
â”‚     }                           â”‚
â”‚   )                             â”‚
â”‚ }                               â”‚
â”‚                                 â”‚
â”‚ _handleGlobalNewMessage() {     â”‚
â”‚   if (senderId != currentUser) { â”‚
â”‚     ğŸš€ loadConversations()      â”‚
â”‚   }                             â”‚
â”‚ }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Repository Call
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DATA SOURCE               â”‚
â”‚                                 â”‚
â”‚ getParticulierConversations() { â”‚
â”‚   ğŸ“± deviceId = getDeviceId()   â”‚
â”‚   ğŸ” userIds = findByDevice()   â”‚
â”‚   ğŸ“¡ conversations = supabase   â”‚
â”‚        .from('conversations')   â”‚
â”‚        .inFilter('user_id',     â”‚
â”‚                  userIds)       â”‚
â”‚   return conversations          â”‚
â”‚ }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Data Processing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CONTROLLER                 â”‚
â”‚                                 â”‚
â”‚ _calculateAndUpdateUnreadCounts â”‚
â”‚ (conversations) {               â”‚
â”‚                                 â”‚
â”‚   for (conversation in list) {  â”‚
â”‚     unreadCount = 0             â”‚
â”‚     for (message in messages) { â”‚
â”‚       isFromVendeur =           â”‚
â”‚         !msg.isFromParticulier  â”‚
â”‚       if (!msg.isRead &&        â”‚
â”‚           isFromVendeur) {      â”‚
â”‚         unreadCount++ â­         â”‚
â”‚       }                         â”‚
â”‚     }                           â”‚
â”‚     ğŸ”„ conversation.copyWith(   â”‚
â”‚          unreadCount: count)    â”‚
â”‚   }                             â”‚
â”‚ }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ State Update
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       RIVERPOD STATE            â”‚
â”‚                                 â”‚
â”‚ state = state.copyWith(         â”‚
â”‚   conversations: updated,       â”‚
â”‚   unreadCount: totalUnread      â”‚
â”‚ )                               â”‚
â”‚                                 â”‚
â”‚ âš¡ notifyListeners()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Widget Rebuild
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CONVERSATION ITEM WIDGET      â”‚
â”‚                                 â”‚
â”‚ didUpdateWidget() {             â”‚
â”‚   _updateAnimation() â­          â”‚
â”‚ }                               â”‚
â”‚                                 â”‚
â”‚ _updateAnimation() {            â”‚
â”‚   hasUnread = conversation      â”‚
â”‚             .unreadCount > 0    â”‚
â”‚                                 â”‚
â”‚   if (hasUnread) {              â”‚
â”‚     ğŸ† animationController      â”‚
â”‚        .repeat(reverse: true)   â”‚
â”‚   }                             â”‚
â”‚ }                               â”‚
â”‚                                 â”‚
â”‚ build() {                       â”‚
â”‚   return AnimatedBuilder(       â”‚
â”‚     child: Transform.scale(     â”‚
â”‚       scale: hasUnread ?        â”‚
â”‚         _pulseAnimation.value : â”‚
â”‚         1.0 â­                   â”‚
â”‚     )                           â”‚
â”‚   )                             â”‚
â”‚ }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ Visual Effects
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        UI RENDERING             â”‚
â”‚                                 â”‚
â”‚ ğŸ¨ EFFETS VISUELS:              â”‚
â”‚                                 â”‚
â”‚ âœ¨ Transform.scale(1.05)        â”‚
â”‚    Animation pulse continue     â”‚
â”‚                                 â”‚
â”‚ ğŸ”´ Card(                        â”‚
â”‚      elevation: 6,              â”‚
â”‚      shadowColor: Colors.red    â”‚
â”‚    )                            â”‚
â”‚                                 â”‚
â”‚ ğŸ”² BorderSide(                  â”‚
â”‚      color: Colors.red,         â”‚
â”‚      width: 2                   â”‚
â”‚    )                            â”‚
â”‚                                 â”‚
â”‚ ğŸŒˆ LinearGradient(              â”‚
â”‚      colors: [red.opacity(0.08), â”‚
â”‚               Colors.white]      â”‚
â”‚    )                            â”‚
â”‚                                 â”‚
â”‚ ğŸ”´ Badge(                       â”‚
â”‚      color: Colors.red,         â”‚
â”‚      text: unreadCount          â”‚
â”‚    )                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    ğŸ‘€ UTILISATEUR VOIT LES EFFETS
```

## âš¡ OPTIMISATIONS PERFORMANCE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          OPTIMISATIONS APPLIQUÃ‰ES                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ”„ REALTIME ARCHITECTURE                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AVANT (Triple abonnement)    â”‚    APRÃˆS (Single abonnement)           â”‚ â”‚
â”‚  â”‚                              â”‚                                         â”‚ â”‚
â”‚  â”‚ â”Œâ”€Controllerâ”€â”€â”€â”€â”             â”‚    â”Œâ”€Controllerâ”€â”€â”€â”€â”                   â”‚ â”‚
â”‚  â”‚ â”‚ - subscribe() â”‚             â”‚    â”‚ - subscribe() â”‚ â­ UNIQUE          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚
â”‚  â”‚ â”Œâ”€ChatPageâ”€â”€â”€â”€â”€â”€â”             â”‚    â”Œâ”€ChatPageâ”€â”€â”€â”€â”€â”€â”                   â”‚ â”‚
â”‚  â”‚ â”‚ - subscribe() â”‚ âŒ REDONDANT â”‚    â”‚ - listen only â”‚ âœ… PASSIF          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚
â”‚  â”‚ â”Œâ”€DataSourceâ”€â”€â”€â”€â”             â”‚    â”Œâ”€DataSourceâ”€â”€â”€â”€â”                   â”‚ â”‚
â”‚  â”‚ â”‚ - subscribe() â”‚ âŒ REDONDANT â”‚    â”‚ - no realtime â”‚ âœ… SIMPLE API      â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚
â”‚  â”‚                              â”‚                                         â”‚ â”‚
â”‚  â”‚ ğŸ“ˆ RÃ©sultat: Messages x3     â”‚    ğŸ“‰ RÃ©sultat: Message unique         â”‚ â”‚
â”‚  â”‚ ğŸŒ Performance dÃ©gradÃ©e      â”‚    âš¡ Performance optimale              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â° POLLING STRATEGY                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AVANT                        â”‚    APRÃˆS                                â”‚ â”‚
â”‚  â”‚ Timer.periodic(10 seconds)   â”‚    Timer.periodic(30 seconds)          â”‚ â”‚
â”‚  â”‚ + loadConversations() full   â”‚    + _loadConversationsQuietly()       â”‚ â”‚
â”‚  â”‚ + setState on every call     â”‚    + setState only on changes          â”‚ â”‚
â”‚  â”‚                              â”‚                                         â”‚ â”‚
â”‚  â”‚ ğŸ“Š Impact:                   â”‚    ğŸ“Š Impact:                           â”‚ â”‚
â”‚  â”‚ â€¢ 6 calls/minute             â”‚    â€¢ 2 calls/minute                     â”‚ â”‚
â”‚  â”‚ â€¢ UI flickering              â”‚    â€¢ Smooth updates                     â”‚ â”‚
â”‚  â”‚ â€¢ Battery drain              â”‚    â€¢ Battery friendly                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  ğŸ§® UNREAD COUNT CALCULATION                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AVANT (Inefficace)           â”‚    APRÃˆS (OptimisÃ©)                     â”‚ â”‚
â”‚  â”‚                              â”‚                                         â”‚ â”‚
â”‚  â”‚ conversations.map((c) => {   â”‚    conversations.map((c) => {           â”‚ â”‚
â”‚  â”‚   final unread = c.messages  â”‚      int unread = 0;                    â”‚ â”‚
â”‚  â”‚     .where((m) => !m.isRead  â”‚      for (final m in c.messages) {     â”‚ â”‚
â”‚  â”‚            && isFromVendeur) â”‚        if (!m.isRead && isFromVendeur) â”‚ â”‚
â”‚  â”‚     .length;                 â”‚          unread++;                      â”‚ â”‚
â”‚  â”‚                              â”‚      }                                  â”‚ â”‚
â”‚  â”‚   return c.copyWith(         â”‚      if (c.unreadCount != unread) {    â”‚ â”‚
â”‚  â”‚     unreadCount: unread      â”‚        return c.copyWith(              â”‚ â”‚
â”‚  â”‚   );                         â”‚          unreadCount: unread);         â”‚ â”‚
â”‚  â”‚ })                           â”‚      }                                  â”‚ â”‚
â”‚  â”‚                              â”‚      return c; // â­ Ã‰vite copyWith    â”‚ â”‚
â”‚  â”‚ ğŸ“ˆ ComplexitÃ©: O(nÂ²)         â”‚    })                                   â”‚ â”‚
â”‚  â”‚ ğŸŒ copyWith() systÃ©matique   â”‚    ğŸ“‰ ComplexitÃ©: O(n)                 â”‚ â”‚
â”‚  â”‚                              â”‚    âš¡ copyWith() conditionnel           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  ğŸ’¾ MEMORY & STATE MANAGEMENT                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ AnimationController dispose() correctement                           â”‚ â”‚
â”‚  â”‚ â€¢ Timer.cancel() dans dispose()                                        â”‚ â”‚
â”‚  â”‚ â€¢ Stream subscriptions properly closed                                 â”‚ â”‚
â”‚  â”‚ â€¢ Conditional copyWith() pour Ã©viter rebuilds inutiles                 â”‚ â”‚
â”‚  â”‚ â€¢ Logs debug dÃ©taillÃ©s pour troubleshooting                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ POINTS CRITIQUES CORRIGÃ‰S

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             CORRECTIONS MAJEURES                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âŒ BUG: Mapping sender_type incorrect                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PROBLÃˆME:                                                               â”‚ â”‚
â”‚  â”‚ â€¢ BDD stocke: sender_type = 'user' (particulier) / 'seller' (vendeur) â”‚ â”‚
â”‚  â”‚ â€¢ Code particulier: isFromParticulier = boolean                        â”‚ â”‚
â”‚  â”‚ â€¢ Mapping: 'user' â†’ isFromParticulier = ??? âŒ CONFUSION              â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ SYMPTÃ”ME:                                                               â”‚ â”‚
â”‚  â”‚ â€¢ unreadCount toujours = 0                                             â”‚ â”‚
â”‚  â”‚ â€¢ Effets visuels jamais dÃ©clenchÃ©s                                     â”‚ â”‚
â”‚  â”‚ â€¢ Messages non lus invisibles                                          â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ SOLUTION APPLIQUÃ‰E:                                                     â”‚ â”‚
â”‚  â”‚ âœ… _mapSupabaseToMessage() {                                           â”‚ â”‚
â”‚  â”‚     // Mapping explicite et robuste                                    â”‚ â”‚
â”‚  â”‚     isFromParticulier: json['sender_type'] == 'user',                  â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ âœ… _calculateAndUpdateUnreadCounts() {                                 â”‚ â”‚
â”‚  â”‚     final isFromVendeur = !msg.isFromParticulier;                      â”‚ â”‚
â”‚  â”‚     // Logique claire: vendeur = NOT particulier                       â”‚ â”‚
â”‚  â”‚   }                                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  âŒ PROBLÃˆME: Triple abonnement Realtime                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ IMPACT:                                                                 â”‚ â”‚
â”‚  â”‚ â€¢ Messages reÃ§us en triple exemplaire                                  â”‚ â”‚
â”‚  â”‚ â€¢ Performance dÃ©gradÃ©e (3x bandwidth)                                  â”‚ â”‚
â”‚  â”‚ â€¢ UI confused avec updates concurrents                                 â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ SOLUTION:                                                               â”‚ â”‚
â”‚  â”‚ âœ… Centralisation dans Controller uniquement                           â”‚ â”‚
â”‚  â”‚ âœ… ChatPage devient passive (Ã©coute state seulement)                   â”‚ â”‚
â”‚  â”‚ âœ… DataSource = API calls pure (no realtime)                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  âŒ PROBLÃˆME: Timestamps UTC/Local mÃ©langÃ©s                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SYMPTÃ”ME:                                                               â”‚ â”‚
â”‚  â”‚ â€¢ DÃ©calage 2h affichÃ© (France UTC+2)                                   â”‚ â”‚
â”‚  â”‚ â€¢ IncohÃ©rence: "Il y a 2h" pour message Ã  l'instant                   â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ SOLUTION:                                                               â”‚ â”‚
â”‚  â”‚ âœ… Backend: Supabase 'now()' pour UTC consistant                       â”‚ â”‚
â”‚  â”‚ âœ… Frontend: .toLocal() dans tous les widgets UI                       â”‚ â”‚
â”‚  â”‚ âœ… Conversion centralisÃ©e dans _formatTimestamp()                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  âŒ PROBLÃˆME: markAsRead() automatique frustrant                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ UX PROBLÃ‰MATIQUE:                                                       â”‚ â”‚
â”‚  â”‚ â€¢ Tap sur conversation â†’ markAsRead() immÃ©diat                         â”‚ â”‚
â”‚  â”‚ â€¢ Utilisateur n'a pas le temps de lire                                 â”‚ â”‚
â”‚  â”‚ â€¢ Badge disparait avant lecture rÃ©elle                                 â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ AMÃ‰LIORATION:                                                           â”‚ â”‚
â”‚  â”‚ âœ… Suppression markAsRead() automatique                                â”‚ â”‚
â”‚  â”‚ âœ… ContrÃ´le utilisateur: bouton explicite "Marquer lu"                 â”‚ â”‚
â”‚  â”‚ âœ… Badge persiste jusqu'Ã  action dÃ©libÃ©rÃ©e                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  âŒ PROBLÃˆME: Effets visuels cachÃ©s                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DEBUG DIFFICILE:                                                        â”‚ â”‚
â”‚  â”‚ â€¢ Badge visible seulement si unreadCount > 0                           â”‚ â”‚
â”‚  â”‚ â€¢ Si bug de calcul â†’ badge invisible = impossible Ã  dÃ©bugger           â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚ SOLUTION DEBUG:                                                         â”‚ â”‚
â”‚  â”‚ âœ… Badge toujours visible avec couleur conditionnelle                  â”‚ â”‚
â”‚  â”‚ âœ… Logs dÃ©taillÃ©s pour chaque Ã©tape de calcul                          â”‚ â”‚
â”‚  â”‚ âœ… Animation visible mÃªme avec count = 0 (debug)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*ğŸ“ Diagrammes crÃ©Ã©s le 13 septembre 2025*  
*ğŸ—ï¸ Architecture Flutter Clean + Riverpod + Supabase*  
*ğŸ¯ Focus: Structure, Flux de donnÃ©es et Optimisations*